% Note, [fragile] is needed when using juliaconsole
\begin{frame}[fragile,t]
\frametitle{Robustness and Smooth Robustness}
\framesubtitle{Example: Eventually $\lozenge$}

\phantom{}

\begin{small}
\textit{First, let's define the \jlv{Eventually} operator in Julia.}
\end{small}

\phantom{}

\pause
{\fontsize{8}{10}\selectfont
\begin{algorithmblock}
\begin{juliaverbatim}
mutable struct Eventually <: Formula
    Ïˆ::Formula
    I::Interval
end
\end{juliaverbatim}
\end{algorithmblock}}

\begin{footnotesize}
\begin{align*}
    \onslide<3->{\lozenge_{[a,b]}\psi &= \top \mathcal{U}_{[a,b]} \psi \\}
                         \onslide<4->{&= \exists t (a \le t \le b) \psi_t}
\end{align*}
\end{footnotesize}

\pause\pause\pause
{\fontsize{8}{10}\selectfont
\begin{algorithmblock}
\begin{juliaverbatim}
(â—Š::Eventually)(x) = any(â—Š.Ïˆ(x[t]) for t âˆˆ interval(â—Š,x)) # Evaluate formula Ïˆ(x)
\end{juliaverbatim}
\end{algorithmblock}}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{frame}[fragile,t]
\frametitle{Robustness and Smooth Robustness}
\framesubtitle{Example: Eventually $\lozenge$}

\pause
\begin{scriptsize}
\begin{equation*}
    \rho(x_t, \lozenge_{[a,b]}\psi) = \max_{t^\prime \in [t+a,t+b]} \rho(x_{t^\prime}, \psi)
\end{equation*}
\end{scriptsize}
\vspace{-0.5\baselineskip}
\pause
{\fontsize{8}{10}\selectfont
\begin{algorithmblock}
\begin{juliaverbatim}
Ï(x, â—Š::Eventually) = maximum(Ï(x[t], â—Š.Ïˆ) for t âˆˆ interval(â—Š,x)) # Robustness
\end{juliaverbatim}
\end{algorithmblock}}

\vspace{\baselineskip}

\pause
\begin{scriptsize}
\begin{equation*}
    \tilde{\rho}(x_t, \lozenge_{[a,b]}\psi) = \operatorname*{\widetilde{\max}}_{t^\prime \in [t+a,t+b]} \tilde{\rho}(x_{t^\prime}, \psi)
\end{equation*}
\end{scriptsize}
\vspace{-0.5\baselineskip}
\pause
{\fontsize{8}{10}\selectfont
\begin{algorithmblock}
\begin{juliaverbatim}
ÏÌƒ(x, â—Š::Eventually; w=1) = smoothmax(ÏÌƒ(x[t], â—Š.Ïˆ; w) for t âˆˆ interval(â—Š,x); w) # Smooth robustness
\end{juliaverbatim}
\end{algorithmblock}}

\vspace{\baselineskip}

\pause
\begin{scriptsize}
\begin{equation*}
    \widetilde{\max}(x; w) = \frac{\sum_i^n x_i \exp(x_i/w)}{\sum_j^n \exp(x_j/w)}
\end{equation*}
\end{scriptsize}
\vspace{-0.5\baselineskip}
\pause
{\fontsize{8}{10}\selectfont
\begin{algorithmblock}
\begin{juliaverbatim}
smoothmax(x; w=1) = (w == 0) ? maximum(x) : sum(xáµ¢*exp(xáµ¢/w) for xáµ¢ in x) / sum(exp(xâ±¼/w) for xâ±¼ in x)
\end{juliaverbatim}
\end{algorithmblock}}

\vspace{\baselineskip}

\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \input{gradientplot.tex}

\begin{frame}[fragile,t]
\frametitle{Robustness and Smooth Robustness}
\framesubtitle{Example: Eventually $\lozenge$}

\phantom{}

\begin{small}
\textit{This means we can use Julia's {\color{captioncolor}auto-differentiation} packages right out-of-the-box!}
\end{small}

\pause
\begin{columns}
\begin{column}[t]{0.5\textwidth}
\begin{tiny}
\begin{juliaconsole}
using SignalTemporalLogic
import ForwardDiff: gradient
Ï„ = [-1.0, -3.2, 2.0, 1.5, 3.0, 0.5, -0.5, -2.0, -4.0, -1.5];
Ïˆ = @formula â—Š(sâ‚œ -> sâ‚œ > 0);
gradient(Ï„->Ï(Ï„, Ïˆ), Ï„)
\end{juliaconsole}
\onslide<2>{\lineblackout{11}}
\onslide<2-3>{\lineblackout{0}\lineblackout{1}\lineblackout{2}\lineblackout{3}\lineblackout{4}\lineblackout{5}\lineblackout{6}\lineblackout{7}\lineblackout{8}\lineblackout{9}\lineblackout{10}}
\end{tiny}
\end{column}

\pause\pause\pause
\begin{column}[t]{0.5\textwidth}
\begin{tiny}
\begin{juliaconsole}
using SignalTemporalLogic; import ForwardDiff: gradient
Ï„ = [-1.0, -3.2, 2.0, 1.5, 3.0, 0.5, -0.5, -2.0, -4.0, -1.5];
Ïˆ = @formula â—Š(sâ‚œ -> sâ‚œ > 0);
# Smooth robustness gradient
gradient(Ï„->ÏÌƒ(Ï„, Ïˆ), Ï„)
\end{juliaconsole}
% \lineblackout{12}
\lineblackout{13}\lineblackout{14}\lineblackout{15}
\onslide<1-6>{\lineblackout{0}\lineblackout{1}\lineblackout{2}\lineblackout{3}\lineblackout{4}\lineblackout{5}\lineblackout{6}\lineblackout{7}\lineblackout{8}\lineblackout{9}\lineblackout{10}}
\onslide<7>{}

\phantom{}

\pause
\jlv{ÏÌƒ # \rho<TAB>\tilde<TAB>}
\end{tiny}
\end{column}
\end{columns}

% \pause
% \begin{tikzpicture}[remember picture, overlay]
%     \node[anchor=south west] at ($(current page.south west)+(1.125cm,0)$) {
%         \input{fig/jl_robustness_gradient} % Use \input not \plot when reusing plots
%     };
% \end{tikzpicture}

\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\begin{frame}[fragile,t]
\frametitle{Robustness and Smooth Robustness}
\framesubtitle{Example: Eventually $\lozenge$}

\phantom{}

\begin{small}
\textit{The textbook (and projects) use aliases for \jlv{Ï} and \jlv{ÏÌƒ}}
\end{small}

\phantom{}

\pause
\begin{juliaverbatim}
robustness(ğ¬, Ïˆ) = Ï(ğ¬, Ïˆ)
\end{juliaverbatim}

\begin{juliaverbatim}
smooth_robustness(ğ¬, Ïˆ; w=1) = ÏÌƒ(ğ¬, Ïˆ; w=1)
\end{juliaverbatim}

\end{frame}